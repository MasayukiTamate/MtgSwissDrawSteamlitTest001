# プログラム詳細分析レポート (code_analysis)

## 分析対象
*   **ファイル名**: `MtgSwissDrawIntegrated.py`

## 1. システム構成
本アプリはStreamlitのマルチページ機能を利用し、メインの大会管理機能に加えてドキュメント（Readme、マニュアル、仕様書）を独立したページとして提供しています。

*   **メインアプリ**: `MtgSwissDrawIntegrated.py` (大会管理)
*   **ドキュメントページ**: `pages/` ディレクトリ配下
    *   `01_📖_Readme.py`: 概要と作者情報
    *   `02_📚_User_Manual.py`: ユーザー操作ガイド
    *   `03_📋_Specifications.py`: 計算ロジックとシステム仕様

### 1.1 多言語対応 (Global Support)
ドキュメントページは `st.tabs` を使用して、日本語と英語のコンテンツをシームレスに切り替えられるように設計されています。

## 2. 概要
本プログラムは、MTGスイスドロー大会の運営管理を行う単一のStreamlitアプリケーションです。従来の関数ベースの処理を廃止し、データとロジックを管理する「Model」と、表示を担当する「View」を明確に分離しました。これにより、コードの可読性、保守性、拡張性が大幅に向上しています。

## 3. 主要クラスとロジック（Model）
ロジックは主に `MtgSwissDrawIntegrated.py` 内に集約されています。
*   **作成日**: 2025/12/22
*   **設計思想**: オブジェクト指向プログラミング (OOP)

## 2. クラス構造分析 (Model)

### 2.1. `MatchResult` (データクラス)
*   **役割**: 1回の対戦結果（相手、勝敗）および**ゲームスコア**を保持する最小単位のデータ構造です。
*   **属性**:
    *   `opponent_name`: 対戦相手の名前。
    *   `result`: "WIN", "LOSE", "DRAW", "BYE"。
    *   `game_wins`: 自分の勝利ゲーム数 (例: 2)。
    *   `game_losses`: 相手の勝利ゲーム数 (例: 1)。

### 2.2. `PlayerData`
*   **役割**: プレイヤー個人の状態を管理します。
*   **主要属性**:
    *   `win_points`: 勝ち点（勝3、分1、負0）。
    *   `history`: 過去の `MatchResult` のリスト。
*   **計算メソッド (タイブレーカー)**:
    *   `calculate_mw_percent()`: マッチ勝率 (Match Win %)。
    *   `calculate_omw_percent()`: オポネント・マッチ勝率 (OMW%)。
    *   `calculate_gw_percent()`: ゲーム勝率 (Game Win %)。
    *   `calculate_ogw_percent()`: オポネント・ゲーム勝率 (OGW%)。

### 2.3. `RoundMatch`
*   **役割**: 現在進行中の「対戦テーブル（卓）」を表現します。
*   **主要メソッド**:
    *   `report_win(winner, w_score, l_score)`: ゲームスコア付きで勝敗を記録し、双方のプレイヤーデータに反映します。

### 2.4. `TournamentManager` (Facade)
*   **データ提供 (`get_standings_df`)**:
    *   順位決定ロジック: 勝ち点 -> OMW% -> GW% -> OGW% の優先順位でソートされたDataFrameを生成します。

## 3. 処理フロー分析 (Flow)

1.  **起動・初期化 (`main`, `init_session`)**:
    *   アプリ起動時、`st.session_state.tm` が存在するか確認し、なければ生成します。
    *   **結果発表判定**: `tm.is_finished` がTrueの場合、通常の対戦画面ではなく `render_final_result` 関数を呼び出し、優勝者や全成績を表示する「結果発表モード」になります。
2.  **イベント処理 (Sidebar/Buttons)**:
    *   **プレイヤー追加**: `tm.add_player()` を呼び出し、すぐに `st.rerun()` することで画面を最新化します。「、」やスペース区切りでの一括登録にも正規表現を用いて対応しています。
    *   **ペアリング開始**:
        *   **第1回戦**: 「並び順（登録順）」または「ランダム（シャッフル）」を選択して開始可能です。
        *   **第2回戦以降**: 勝ち点に基づいたスイスドロー・ペアリングが行われます。
    *   **ラウンド進行 (`start_new_round`)**: 全プレイヤーを勝ち点順にソートし、貪欲法アルゴリズムを用いてペアリングを行います。全試合結果が確定していない場合、次のラウンド生成や大会終了処理はブロックされます（ガード機能）。
        *   可能な限り「まだ対戦していない」相手を優先して選出します。
    *   **結果入力**: 各対戦カードのスコア選択（2-0, 2-1等）とボタン押下により、勝敗とゲームスコアが記録されます（BO3対応）。一度入力した結果も、中央に表示される「修正(Reset)」ボタンで取り消し・再入力が可能です。
    *   **大会終了**:
        *   **自動**: ペアリング不能時（総当たり完了）。
        *   **手動**: ラウンド3以降、UIに表示される「大会を終了して結果を見る」ボタンで任意に終了可能。
    *   **タイブレーカー計算**: MTG公式ルールに基づき、MW%（マッチ勝率）およびGW%（ゲーム勝率）の算出において、BYE（不戦勝）は「獲得ポイント」および「試合数/ゲーム数（分母）」の両方から除外されます。これにより、不戦勝が含まれるプレイヤーでも公平なタイブレーカーが算出されます。
    *   **サイドバー**: 常に開いた状態 (`expanded`) を維持し、どの画面からでもリセットやプレイヤー追加が可能です。

## 4. 総評
以前のバージョン（v1, v2）からの主要な改善点は以下の通りです。

*   **カプセル化**: 点数計算ロジックが `PlayerData` クラス内に閉じているため、「点数の足し忘れ」などのバグが起きにくくなりました。
*   **一元管理**: `TournamentManager` が全ての状態を持つため、変数が散らばることによる状態不整合が解消されました。
*   **拡張性**: 将来的に「オポネント・マッチ・ウィン・パーセンテージ」などの複雑な計算を入れる場合でも、`PlayerData` クラスに計算メソッドを追加するだけで対応可能です。

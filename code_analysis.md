# プログラム詳細分析レポート (code_analysis)

## 分析対象
*   **ファイル名**: `MtgSwissDrawIntegrated.py`
*   **作成日**: 2025/12/22
*   **設計思想**: オブジェクト指向プログラミング (OOP)

## 1. 概要
本プログラムは、MTGスイスドロー大会の運営管理を行う単一のStreamlitアプリケーションです。従来の関数ベースの処理を廃止し、データとロジックを管理する「Model」と、表示を担当する「View」を明確に分離しました。これにより、コードの可読性、保守性、拡張性が大幅に向上しています。

## 2. クラス構造分析 (Model)

### 2.1. `MatchResult` (データクラス)
*   **役割**: 1回の対戦結果（相手、勝敗）を保持する最小単位のデータ構造です。
*   **特徴**: `dataclass`を使用しており、データの保持に特化しています。

### 2.2. `PlayerData`
*   **役割**: プレイヤー個人の状態を管理します。
*   **主要属性**:
    *   `win_points`: 勝ち点（勝3、分1、負0）。スイスドロー順位の基礎となります。
    *   `match_win_count`: 純粋な勝利回数。
    *   `history`: 過去の `MatchResult` のリスト。
*   **主要メソッド**:
    *   `add_result()`: 勝敗を受け取り、自動的に勝ち点計算を行って履歴に追加します。外部から直接ポイントを操作するのではなく、結果を報告させることでデータの整合性を保ちます。

### 2.3. `RoundMatch`
*   **役割**: 現在進行中の「対戦テーブル（卓）」を表現します。プレイヤーAとプレイヤーB（またはNone=Bye）の対戦状況を管理します。
*   **主要メソッド**:
    *   `report_win(winner)`: 勝者が決定した際の処理を集約しています。勝者には勝ち点を与え、敗者には負けを記録するという一連のトランザクションを実行します。
    *   `report_draw()`: ジャッジによる引き分け処理などを想定したメソッドです。

### 2.4. `TournamentManager` (Facade)
*   **役割**: システム全体の司令塔となるクラスです。Streamlitの `session_state` に保存される唯一のモデルインスタンスです。
*   **機能**:
    *   **プレイヤー管理**: 参加者のリスト管理（追加・削除）。
    *   **ラウンド進行 (`start_new_round`)**:  現在の最も重要なロジックです。全プレイヤーを勝ち点順にソートし、貪欲法アルゴリズムを用いてペアリングを行います。
        *   可能な限り「まだ対戦していない」相手を優先して選出します。
        *   全員と対戦済みの場合は、勝ち点が近い相手と再戦になります。
    *   **データ提供**:
        *   `get_standings_df()`: 現在の順位表（勝ち点順）を提供します。
        *   `get_history_df()`: 各プレイヤーの対戦履歴をラウンドごとにカラム化したテーブル（ID順）を提供します。UIの可読性を高めるために分離されています。

## 3. 処理フロー分析 (Flow)

1.  **起動・初期化 (`main`, `init_session`)**:
    *   アプリ起動時、`st.session_state.tm` が存在するか確認し、なければ `TournamentManager` を新規生成します。これにより、ブラウザの再描画（Rerun）が発生しても大会データが保持されます。
2.  **イベント処理 (Sidebar/Buttons)**:
    *   **プレイヤー追加**: `tm.add_player()` を呼び出し、すぐに `st.rerun()` することで画面を最新化します。
    *   **対戦開始**: 参加者が偶数か奇数かを問わず、`tm.start_new_round()` が適切なペアリング（奇数ならBye生成）を行います。
    *   **結果入力**: 各対戦カードのボタンが押されると、対応する `RoundMatch` オブジェクトのメソッドが呼ばれ、内部状態（`PlayerData`の点数など）が更新されます。

## 4. 総評
以前のバージョン（v1, v2）からの主要な改善点は以下の通りです。

*   **カプセル化**: 点数計算ロジックが `PlayerData` クラス内に閉じているため、「点数の足し忘れ」などのバグが起きにくくなりました。
*   **一元管理**: `TournamentManager` が全ての状態を持つため、変数が散らばることによる状態不整合が解消されました。
*   **拡張性**: 将来的に「オポネント・マッチ・ウィン・パーセンテージ」などの複雑な計算を入れる場合でも、`PlayerData` クラスに計算メソッドを追加するだけで対応可能です。
